# 故障排查指南

## 一、常见问题快速诊断

### 问题 1: 服务无法启动

**症状**: 
- 运行 `python run.py` 后立即退出
- 提示端口被占用
- 提示数据库连接失败

**诊断步骤**:

1. **检查端口占用**:
```bash
# Windows
netstat -ano | findstr :8000

# Linux/Mac
lsof -i :8000
# 或
sudo netstat -tulpn | grep 8000
```

**解决方案**:
- 关闭占用端口的进程
- 或修改服务端口: `uvicorn ... --port 8001`

2. **检查数据库连接**:
```bash
# 测试数据库连接
psql -U postgres -d intent_system -c "SELECT 1;"
```

**可能原因**:
- PostgreSQL 服务未启动
- 数据库不存在
- 用户名/密码错误
- 网络问题

**解决方案**:
```bash
# 启动 PostgreSQL (Linux)
sudo systemctl start postgresql

# 创建数据库
createdb -U postgres intent_system

# 检查 .env 配置
cat .env | grep DATABASE_URL
```

3. **检查 Python 环境**:
```bash
# 确认 Python 版本
python --version  # 需要 3.11+

# 确认依赖已安装
pip list | grep fastapi
```

### 问题 2: API 返回 500 错误

**症状**:
- API 请求返回 500 Internal Server Error
- 用户侧可能看到统一提示「处理时发生错误，请稍后重试。」（Chat/流式 Chat 不向用户暴露内部异常信息）

**诊断步骤**:

1. **查看错误日志**:
```bash
# 查看最新错误
tail -100 logs/app.log | grep ERROR

# 查看完整堆栈
tail -200 logs/app.log
```

2. **常见错误类型**:

**数据库错误**:
```
sqlalchemy.exc.OperationalError: could not connect to server
```
**解决**: 检查数据库连接配置

**OpenAI API 错误**:
```
openai.error.AuthenticationError: Invalid API key
```
**解决**: 检查 OPENAI_API_KEY 环境变量

**向量库错误**:
```
chromadb.errors.InvalidCollectionException
```
**解决**: 重新初始化向量库或重新索引

3. **启用调试模式**:
```python
# 在 run.py 中
import logging
logging.basicConfig(level=logging.DEBUG)
```

4. **Chat/流式接口 500**：服务端会记录完整 traceback（如 `orchestrator process failed`、`chat_stream failed`），根据日志定位具体异常。

### 问题 3: 检索结果不准确

**症状**:
- 返回的内容与问题不相关
- 检索不到相关内容

**诊断步骤**:

1. **检查文档索引**:
```bash
# 查看资源是否存在
curl http://localhost:8000/v1/resources/res_doc_c_language

# 检查文档是否已索引
# 查看数据库中的 chunks
psql -U postgres -d intent_system -c "SELECT COUNT(*) FROM resource_docs WHERE resource_id = 'res_doc_c_language';"
```

2. **重新索引文档**:
```bash
curl -X POST http://localhost:8000/v1/resources/res_doc_c_language/reindex
```

3. **检查向量库**:
```python
# 检查向量库中的文档
from services.retrieval.vector_store import VectorStore
vector_store = VectorStore()
# 查看集合
print(vector_store.doc_chunks_collection.count())
```

4. **调整检索参数**:
```yaml
# config/ranking.yaml
weights:
  semantic: 0.6  # 提高语义权重
  keyword: 0.4
```

### 问题 4: 响应时间过长

**症状**:
- API 响应时间 > 10 秒
- 用户等待时间过长

**诊断步骤**:

1. **分析响应时间**:
```bash
# 使用 time 命令
time curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "测试"}'
```

2. **检查各组件耗时**:

**数据库查询慢**:
```sql
-- 查看慢查询
SELECT query, mean_exec_time, calls 
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 10;
```

**解决**: 添加索引、优化查询

**LLM 调用慢**:
- 检查 OpenAI API 响应时间
- 考虑使用更快的模型（gpt-3.5-turbo）

**向量检索慢**:
- 检查向量库大小
- 减少 top_k 参数
- 考虑使用更快的向量库（Pinecone）

3. **性能分析**:
```python
# 使用 cProfile
import cProfile
cProfile.run('orchestrator.process(...)')
```

### 问题 5: 内存占用过高

**症状**:
- 服务内存占用持续增长
- 系统变慢或崩溃

**诊断步骤**:

1. **检查内存使用**:
```bash
# 查看进程内存
ps aux | grep python

# 或使用 top
top -p $(pgrep -f "python run.py")
```

2. **查找内存泄漏**:
```python
# 使用 memory_profiler
pip install memory-profiler

# 在代码中添加装饰器
@profile
def process_message():
    ...
```

3. **常见原因**:
- 未关闭数据库连接
- 向量库缓存过大
- 日志文件未轮转

**解决方案**:
```python
# 确保连接关闭
with get_db_context() as db:
    # 使用数据库
    pass

# 限制向量库缓存
vector_store = VectorStore()
vector_store.doc_chunks_collection.delete(where={})  # 清理
```

## 二、数据库问题

### 问题: 数据库连接池耗尽

**症状**:
```
sqlalchemy.exc.TimeoutError: QueuePool limit of size X overflow Y reached
```

**解决**:
```python
# 增加连接池大小
engine = create_engine(
    DATABASE_URL,
    pool_size=20,      # 增加池大小
    max_overflow=40    # 增加溢出连接
)
```

### 问题: 表锁死

**症状**:
- 查询长时间无响应
- 数据库连接挂起

**诊断**:
```sql
-- 查看锁
SELECT * FROM pg_locks WHERE NOT granted;

-- 查看等待的查询
SELECT * FROM pg_stat_activity WHERE wait_event_type = 'Lock';
```

**解决**:
```sql
-- 终止阻塞的查询
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE pid = <blocking_pid>;
```

### 问题: 数据库空间不足

**症状**:
```
could not extend file: No space left on device
```

**诊断**:
```sql
-- 查看数据库大小
SELECT pg_size_pretty(pg_database_size('intent_system'));

-- 查看表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**解决**:
```sql
-- 清理过期数据
DELETE FROM results WHERE fresh_until < NOW() - INTERVAL '30 days';
DELETE FROM workflow_runs WHERE created_at < NOW() - INTERVAL '90 days';

-- 清理后回收空间
VACUUM FULL;
```

## 三、LLM API 问题（OpenAI / DeepSeek / Claude / Qianwen）

### 问题: API Key 无效或调用失败

**症状**:
```
openai.error.AuthenticationError: Invalid API key provided
# 或 Anthropic / 其他提供商类似错误
```

**解决**:
1. 确认当前使用的提供商与对应 Key（优先使用 .env 中配置的密钥）:
   - **OpenAI**: `OPENAI_API_KEY`、可选 `OPENAI_API_BASE`
   - **DeepSeek**: `DEEPSEEK_API_KEY`
   - **Claude**: `ANTHROPIC_API_KEY`（需 `pip install anthropic`）
   - **Qianwen**: `DASHSCOPE_API_KEY`、可选 `DASHSCOPE_BASE_URL`
2. 若未设置 `LLM_PROVIDER`，系统会按「OpenAI → DeepSeek → Claude → Qianwen」顺序选用第一个已配置的 Key，请确保目标提供商的 Key 已正确填写。
3. 验证 Key（示例）:
```bash
# OpenAI
curl https://api.openai.com/v1/models -H "Authorization: Bearer $OPENAI_API_KEY"

# DeepSeek（OpenAI 兼容）
curl https://api.deepseek.com/v1/models -H "Authorization: Bearer $DEEPSEEK_API_KEY"
```
4. 重新设置或更新 `.env` 文件后重启服务。
5. 详见 [LLM 多提供商配置](07_LLM多提供商配置.md)。

### 问题: 速率限制

**症状**:
```
openai.error.RateLimitError: Rate limit reached
# 或其他提供商的限流错误
```

**解决**:
1. 实现重试和退避:
```python
import time
from openai import OpenAI

def call_with_retry(client, max_retries=3):
    for i in range(max_retries):
        try:
            return client.chat.completions.create(...)
        except RateLimitError:
            if i < max_retries - 1:
                time.sleep(2 ** i)  # 指数退避
            else:
                raise
```

2. 减少请求频率
3. 升级 API 计划

### 问题: 余额不足

**症状**:
```
openai.error.APIError: Insufficient quota
```

**解决**:
1. 登录 OpenAI 平台检查余额
2. 充值账户
3. 设置使用限额

## 四、向量库问题

### 问题: 向量库损坏

**症状**:
- 检索返回空结果
- 向量库文件错误

**解决**:
```bash
# 备份当前向量库
cp -r ./data/chroma ./data/chroma_backup

# 重新索引所有文档
python scripts/reindex_all.py
```

### 问题: 向量库过大

**症状**:
- 磁盘空间不足
- 检索速度变慢

**解决**:
1. 清理未使用的资源:
```python
from services.retrieval.vector_store import VectorStore
vector_store = VectorStore()
vector_store.delete_by_resource_id("res_xxx")
```

2. 迁移到云向量库（Pinecone/Qdrant）

## 五、工作流执行问题

### 问题: 工作流执行失败

**症状**:
- 工作流返回 failed 状态
- 执行记录中有错误信息

**诊断**:
```bash
# 查看执行记录（若带 tenant_id 未查到，接口会自动再按 run_id 查一次）
curl "http://localhost:8000/v1/workflows/runs/run_xxx?tenant_id=default"
```

**常见错误**:
- 输入参数不匹配
- 工具调用失败
- 超时

**解决**:
1. 检查输入参数是否符合 schema
2. 检查工具配置
3. 增加超时时间

### 问题: 获取执行记录返回 404（Run not found）

**症状**: `GET /v1/workflows/runs/{run_id}` 返回 404。

**解决**:
1. 确认 URL 为 `GET /v1/workflows/runs/{run_id}`（不要漏掉 `/v1/workflows` 前缀）。
2. 若执行时未传 tenant_id 或与查询时不一致，可去掉查询参数再试，或保持与执行时相同的 tenant_id。

### 问题: 工作流执行成功但 outputs 中 step_0.result 为空

**说明**: 含 RETRIEVE 步骤的工作流会调用 DOC 检索器，结果在 `outputs.result.step_0.result`。若为空，请检查文档是否已索引、query 是否从 inputs 正确传入（如 `query_template: "{{query}}"` 对应 `inputs.query`）。

### 问题: 幂等性冲突

**症状**:
- 相同请求重复执行
- 结果不一致

**解决**:
```bash
# 使用 idempotency_key
curl -X POST http://localhost:8000/v1/workflows/wf_xxx/run \
  -d '{
    "inputs": {...},
    "idempotency_key": "unique-key-123"
  }'
```

## 六、日志分析

### 查看错误日志

```bash
# 查看最近的错误
tail -100 logs/app.log | grep ERROR

# 统计错误类型
grep ERROR logs/app.log | awk '{print $5}' | sort | uniq -c

# 查看特定时间的日志
grep "2026-01-23" logs/app.log | grep ERROR
```

### 分析性能日志

```bash
# 查找慢请求
grep "duration_ms" logs/app.log | awk '$NF > 5000'

# 统计平均响应时间
grep "duration_ms" logs/app.log | awk '{sum+=$NF; count++} END {print sum/count}'
```

## 七、紧急恢复

### 服务完全无法访问

1. **检查服务状态**:
```bash
ps aux | grep python
```

2. **重启服务**:
```bash
# 停止服务
pkill -f "python run.py"

# 启动服务
python run.py
```

3. **检查依赖服务**:
```bash
# 数据库
systemctl status postgresql

# 网络
ping api.openai.com
```

### 数据丢失

1. **从备份恢复**:
```bash
# 恢复数据库
psql -U postgres intent_system < backup.sql

# 恢复向量库
tar -xzf chroma_backup.tar.gz -C ./data/
```

2. **重新索引**:
```bash
python scripts/reindex_all.py
```

## 八、获取帮助

### 日志收集

收集以下信息用于问题诊断:
1. 错误日志: `logs/app.log`
2. 系统日志: `/var/log/syslog` (Linux)
3. 数据库日志: PostgreSQL 日志
4. 配置信息: `.env` (脱敏后)
5. 系统信息: `python --version`, `pip list`

### 联系支持

提供以下信息:
- 问题描述
- 错误信息
- 复现步骤
- 日志文件
- 环境信息

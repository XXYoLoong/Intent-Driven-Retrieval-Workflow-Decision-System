# 使用说明

## 一、API 接口概览

### 基础信息
- **Base URL**: `http://localhost:8000`
- **API 版本**: `v1`
- **数据格式**: JSON
- **认证**: 当前无需认证（生产环境建议添加）

### 主要接口
1. **Chat API**: 聊天对话接口
2. **Resource API**: 资源管理接口
3. **Workflow API**: 工作流执行接口
4. **Replay API**: 追踪回放接口

## 二、Chat API 使用

### 1. 同步聊天接口

**端点**: `POST /v1/chat`

**请求示例**:
```bash
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "如何修改 C 语言中的数组元素？",
    "session_id": "session_123",
    "user_id": "user_456",
    "context": {
      "tenant_id": "default"
    },
    "options": {
      "output_format": "steps",
      "debug": false,
      "show_routing": false
    }
  }'
```

**请求参数**:
- `message` (必需): 用户消息
- `session_id` (可选): 会话ID，用于多轮对话
- `user_id` (可选): 用户ID
- `context` (可选): 上下文信息
  - `tenant_id`: 租户ID（多租户隔离）
  - 其他自定义字段
- `options` (可选): 选项
  - `output_format`: 输出格式（text/steps/json/table）
  - `debug`: 是否返回调试信息
  - `show_routing`: 是否显示路由信息

**响应示例**:
```json
{
  "session_id": "session_123",
  "answer": "## 总结\n修改 C 语言中的数组元素...\n\n## 步骤\n1. 使用索引访问数组元素...",
  "meta": {
    "intent": "KNOWLEDGE_QA",
    "action_type": "RETURN_RESULT",
    "selected_resource_id": "res_doc_c_language",
    "run_id": null,
    "citations": [
      {
        "source": "doc://res_doc_c_language#chunk_5",
        "id": "chunk_5"
      }
    ]
  }
}
```

### 2. 流式聊天接口

**端点**: `POST /v1/chat/stream`

**请求示例**:
```bash
curl -X POST http://localhost:8000/v1/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "如何修改 C 语言中的数组元素？",
    "context": {"tenant_id": "default"}
  }'
```

**响应格式** (Server-Sent Events):
```
event: routing_plan
data: {"status": "planning"}

event: decision
data: {"action_type": "RETURN_RESULT"}

event: delta_answer
data: {"delta": "## 总结\n"}

event: delta_answer
data: {"delta": "修改 C 语言中的数组元素..."}

event: final
data: {"answer": "...", "meta": {...}}
```

**JavaScript 示例**:
```javascript
const eventSource = new EventSource('/v1/chat/stream', {
  method: 'POST',
  body: JSON.stringify({
    message: '如何修改 C 语言中的数组元素？',
    context: { tenant_id: 'default' }
  })
});

eventSource.addEventListener('delta_answer', (e) => {
  const data = JSON.parse(e.data);
  console.log(data.delta);
});

eventSource.addEventListener('final', (e) => {
  const data = JSON.parse(e.data);
  console.log('完整回答:', data.answer);
});
```

## 三、Resource API 使用

### 1. 注册资源

**端点**: `POST /v1/resources`

**请求示例**:
```bash
curl -X POST http://localhost:8000/v1/resources \
  -H "Content-Type: application/json" \
  -d '{
    "id": "res_doc_example",
    "type": "DOC",
    "title": "示例文档",
    "capabilities": ["知识问答"],
    "tags": ["文档", "示例"],
    "status": "active",
    "pointers": {
      "doc_uri": "docs/example.md"
    }
  }'
```

### 2. 获取资源

**端点**: `GET /v1/resources/{resource_id}`

**请求示例**:
```bash
curl http://localhost:8000/v1/resources/res_doc_example?tenant_id=default
```

### 3. 列出资源

**端点**: `GET /v1/resources`

**查询参数**:
- `type`: 资源类型（DOC/WORKFLOW/RESULT/TOOL）
- `status`: 状态（active/disabled/deprecated）
- `tenant_id`: 租户ID
- `tags`: 标签（多个用逗号分隔）
- `limit`: 返回数量（默认100）
- `offset`: 偏移量（默认0）

**请求示例**:
```bash
# 列出所有文档资源
curl "http://localhost:8000/v1/resources?type=DOC&status=active"

# 按标签筛选
curl "http://localhost:8000/v1/resources?tags=C语言,编程"
```

### 4. 更新资源

**端点**: `PUT /v1/resources/{resource_id}`

**请求示例**:
```bash
curl -X PUT http://localhost:8000/v1/resources/res_doc_example \
  -H "Content-Type: application/json" \
  -d '{
    "title": "更新后的标题",
    "tags": ["新标签"]
  }'
```

### 5. 删除资源

**端点**: `DELETE /v1/resources/{resource_id}`

**请求示例**:
```bash
curl -X DELETE http://localhost:8000/v1/resources/res_doc_example?tenant_id=default
```

### 6. 重建索引

**端点**: `POST /v1/resources/{resource_id}/reindex`

**请求示例**:
```bash
curl -X POST http://localhost:8000/v1/resources/res_doc_example/reindex
```

**说明**: 重新处理文档，更新向量索引。

## 四、Workflow API 使用

### 1. 执行工作流

**端点**: `POST /v1/workflows/{workflow_id}/run`

**请求示例**:
```bash
curl -X POST http://localhost:8000/v1/workflows/wf_c_language_search_v1/run \
  -H "Content-Type: application/json" \
  -d '{
    "inputs": {
      "query": "如何修改数组元素？",
      "focus": "修改"
    },
    "idempotency_key": "optional-key-123"
  }' \
  "?tenant_id=default&user_id=user_123"
```

**响应示例**:
```json
{
  "run_id": "run_20260123_123456_abc123",
  "workflow_id": "wf_c_language_search_v1",
  "status": "success",
  "outputs": {
    "answer": "...",
    "sources": [...]
  },
  "from_cache": false
}
```

### 2. 获取执行记录

**端点**: `GET /v1/workflows/runs/{run_id}`

**请求示例**:
```bash
curl http://localhost:8000/v1/workflows/runs/run_20260123_123456_abc123?tenant_id=default
```

**响应示例**:
```json
{
  "run_id": "run_20260123_123456_abc123",
  "workflow_id": "wf_c_language_search_v1",
  "status": "success",
  "started_at": "2026-01-23T12:34:56Z",
  "ended_at": "2026-01-23T12:34:58Z",
  "inputs": {...},
  "outputs": {...},
  "artifacts": [],
  "errors": []
}
```

## 五、使用场景示例

### 场景 1: 知识问答

**问题**: "如何修改 C 语言中的字符串？"

**请求**:
```bash
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "如何修改 C 语言中的字符串？",
    "context": {"tenant_id": "default"},
    "options": {"output_format": "steps"}
  }'
```

**系统流程**:
1. Router 识别意图为 `KNOWLEDGE_QA`
2. 检索 DOC 资源（C 语言文档）
3. Decider 选择最相关的文档片段
4. Answerer 生成步骤化回答

### 场景 2: 状态查询

**问题**: "查询订单 12345 的状态"

**请求**:
```bash
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "查询订单 12345 的状态",
    "context": {
      "tenant_id": "default",
      "user_id": "user_123"
    },
    "options": {"output_format": "json"}
  }'
```

**系统流程**:
1. Router 识别意图为 `LOOKUP_STATUS`
2. 检索 RESULT 资源（历史执行结果）
3. 如果找到新鲜结果，直接返回
4. 否则执行工作流查询

### 场景 3: 执行任务

**问题**: "帮我重置密码"

**请求**:
```bash
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "帮我重置密码",
    "context": {
      "tenant_id": "default",
      "user_id": "user_123"
    }
  }'
```

**系统流程**:
1. Router 识别意图为 `EXECUTE_TASK`
2. 检索 WORKFLOW 资源（密码重置工作流）
3. Decider 决定执行工作流
4. Executor 执行工作流
5. Answerer 基于执行结果生成回答

## 六、输出格式说明

### 1. text（纯文本）

**特点**: 自然语言回答，行内引用

**示例**:
```
修改 C 语言中的字符串可以通过直接索引修改或使用 strcpy 函数。
[来源: C 语言编程指南](doc://res_doc_c_language#chunk_3)
```

### 2. steps（步骤化，默认）

**特点**: 结构化说明，包含总结、步骤、证据

**示例**:
```
## 总结
修改 C 语言中的字符串有两种方法：直接索引修改和使用字符串函数。

## 步骤
1. 直接索引修改：通过数组索引访问并修改字符
   [来源: C 语言编程指南](doc://res_doc_c_language#chunk_3)
2. 使用 strcpy 函数：复制新字符串覆盖原字符串
   [来源: C 语言编程指南](doc://res_doc_c_language#chunk_3)

## 证据
- [C 语言编程指南 - 字符串操作](doc://res_doc_c_language#chunk_3)
```

### 3. json（JSON 格式）

**特点**: 结构化数据，适合程序处理

**示例**:
```json
{
  "answer": "修改 C 语言中的字符串...",
  "data": {
    "methods": [
      {"name": "直接索引", "example": "str[0] = 'h';"},
      {"name": "strcpy", "example": "strcpy(str, \"new\");"}
    ]
  },
  "citations": [
    {
      "source": "doc://res_doc_c_language#chunk_3",
      "id": "chunk_3",
      "span": "字符串操作章节"
    }
  ]
}
```

### 4. table（表格格式）

**特点**: 适合列表、对比类查询

**示例**:
```
| 方法 | 说明 | 示例 |
|------|------|------|
| 直接索引 | 通过数组索引修改 | `str[0] = 'h';` |
| strcpy | 复制新字符串 | `strcpy(str, "new");` |

[来源: C 语言编程指南](doc://res_doc_c_language#chunk_3)
```

## 七、多租户使用

### 租户隔离

系统支持多租户隔离，通过 `tenant_id` 实现：

```bash
# 租户 A 的资源
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "如何修改数组？",
    "context": {"tenant_id": "tenant_a"}
  }'

# 租户 B 的资源（隔离）
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "如何修改数组？",
    "context": {"tenant_id": "tenant_b"}
  }'
```

### 用户级隔离

对于 RESULT 类型资源，还支持用户级隔离：

```bash
curl -X POST http://localhost:8000/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "查询我的订单",
    "context": {
      "tenant_id": "tenant_a",
      "user_id": "user_123"
    }
  }'
```

## 八、错误处理

### 常见错误码

- `400 Bad Request`: 请求参数错误
- `404 Not Found`: 资源不存在
- `500 Internal Server Error`: 服务器内部错误

### 错误响应格式

```json
{
  "detail": "错误描述信息",
  "error_code": "ERROR_CODE",
  "trace_id": "trace_xxx"
}
```

### 处理建议

1. **检查请求参数**: 确保 JSON 格式正确
2. **检查资源ID**: 确保资源存在
3. **检查租户ID**: 确保有权限访问
4. **查看日志**: 检查服务器日志获取详细信息

## 九、最佳实践

### 1. 会话管理

使用 `session_id` 维护多轮对话上下文：

```bash
# 第一轮
curl -X POST http://localhost:8000/v1/chat \
  -d '{"message": "如何修改数组？", "session_id": "session_123"}'

# 第二轮（引用上下文）
curl -X POST http://localhost:8000/v1/chat \
  -d '{"message": "那字符串呢？", "session_id": "session_123"}'
```

### 2. 幂等性

工作流执行支持幂等性，使用 `idempotency_key`：

```bash
curl -X POST http://localhost:8000/v1/workflows/wf_xxx/run \
  -d '{
    "inputs": {...},
    "idempotency_key": "unique-key-123"
  }'
```

### 3. 错误重试

对于临时错误，建议实现重试机制：

```python
import time
import requests

def chat_with_retry(message, max_retries=3):
    for i in range(max_retries):
        try:
            response = requests.post(
                'http://localhost:8000/v1/chat',
                json={'message': message}
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            if i == max_retries - 1:
                raise
            time.sleep(2 ** i)  # 指数退避
```

### 4. 批量处理

对于大量请求，建议使用异步或批量接口（如需要可扩展）。

## 十、性能优化建议

1. **使用流式接口**: 对于长回答，使用流式接口提升用户体验
2. **缓存结果**: 对于相同查询，可以缓存结果
3. **异步处理**: 对于耗时操作，使用异步任务
4. **连接复用**: 使用 HTTP 连接池复用连接
